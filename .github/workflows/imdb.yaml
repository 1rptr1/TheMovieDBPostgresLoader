name: IMDb Pipeline

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  imdb:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Download IMDb data
        run: |
          mkdir -p data
          wget -q https://datasets.imdbws.com/name.basics.tsv.gz -O - | gunzip > data/name.basics.tsv
          wget -q https://datasets.imdbws.com/title.akas.tsv.gz -O - | gunzip > data/title.akas.tsv
          wget -q https://datasets.imdbws.com/title.basics.tsv.gz -O - | gunzip > data/title.basics.tsv
          wget -q https://datasets.imdbws.com/title.crew.tsv.gz -O - | gunzip > data/title.crew.tsv
          wget -q https://datasets.imdbws.com/title.episode.tsv.gz -O - | gunzip > data/title.episode.tsv
          wget -q https://datasets.imdbws.com/title.principals.tsv.gz -O - | gunzip > data/title.principals.tsv
          wget -q https://datasets.imdbws.com/title.ratings.tsv.gz -O - | gunzip > data/title.ratings.tsv

      - name: Start Postgres
        run: docker compose -f docker-compose.yml -p imdb up -d

      - name: Wait for Postgres
        run: |
          until docker exec imdb_postgres pg_isready -U imdb; do
            echo "Waiting for postgres..."
            sleep 5
          done
      - name: Debug init directory
        run: |
          docker exec imdb_postgres ls -R /docker-entrypoint-initdb.d
      - name: Show Postgres logs
        run: docker logs imdb_postgres
      - name: Verify tables created and loaded
        run: |
          echo "üîç Checking tables..."
          docker exec -i imdb_postgres psql -U imdb -d imdb -c "\dt"
          
          echo "üîç Checking row counts..."
          docker exec -i imdb_postgres psql -U imdb -d imdb -c "SELECT COUNT(*) AS name_basics_count FROM name_basics;" || exit 1
          docker exec -i imdb_postgres psql -U imdb -d imdb -c "SELECT COUNT(*) AS title_basics_count FROM title_basics;" || exit 1
          docker exec -i imdb_postgres psql -U imdb -d imdb -c "SELECT COUNT(*) AS title_principals_count FROM title_principals;" || exit 1
          docker exec -i imdb_postgres psql -U imdb -d imdb -c "SELECT COUNT(*) AS title_akas_count FROM title_akas;" || exit 1
          docker exec -i imdb_postgres psql -U imdb -d imdb -c "SELECT COUNT(*) AS title_crew_count FROM title_crew;" || exit 1
          docker exec -i imdb_postgres psql -U imdb -d imdb -c "SELECT COUNT(*) AS title_episode_count FROM title_episode;" || exit 1
          docker exec -i imdb_postgres psql -U imdb -d imdb -c "SELECT COUNT(*) AS title_ratings_count FROM title_ratings;" || exit 1

      - name: Show Postgres logs
        run: docker logs imdb_postgres

      - name: Load IMDb data into Postgres
        run: docker exec -i imdb_postgres psql -U imdb -d imdb -f /queries/load_data.sql

      - name: Run Chris Hemsworth query
        run: docker exec -i imdb_postgres psql -U imdb -d imdb -f /queries/chris_hemsworth_movies.sql