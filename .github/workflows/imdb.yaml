name: IMDb Pipeline

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  imdb:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Download IMDb data
        run: |
          mkdir -p data
          echo "üì• Downloading IMDb data files..."
          wget -q https://datasets.imdbws.com/name.basics.tsv.gz -O - | gunzip > data/name.basics.tsv
          echo "‚úÖ Downloaded name.basics.tsv ($(wc -l < data/name.basics.tsv) lines)"
          wget -q https://datasets.imdbws.com/title.akas.tsv.gz -O - | gunzip > data/title.akas.tsv
          echo "‚úÖ Downloaded title.akas.tsv ($(wc -l < data/title.akas.tsv) lines)"
          wget -q https://datasets.imdbws.com/title.basics.tsv.gz -O - | gunzip > data/title.basics.tsv
          echo "‚úÖ Downloaded title.basics.tsv ($(wc -l < data/title.basics.tsv) lines)"
          wget -q https://datasets.imdbws.com/title.crew.tsv.gz -O - | gunzip > data/title.crew.tsv
          echo "‚úÖ Downloaded title.crew.tsv ($(wc -l < data/title.crew.tsv) lines)"
          wget -q https://datasets.imdbws.com/title.episode.tsv.gz -O - | gunzip > data/title.episode.tsv
          echo "‚úÖ Downloaded title.episode.tsv ($(wc -l < data/title.episode.tsv) lines)"
          wget -q https://datasets.imdbws.com/title.principals.tsv.gz -O - | gunzip > data/title.principals.tsv
          echo "‚úÖ Downloaded title.principals.tsv ($(wc -l < data/title.principals.tsv) lines)"
          wget -q https://datasets.imdbws.com/title.ratings.tsv.gz -O - | gunzip > data/title.ratings.tsv
          echo "‚úÖ Downloaded title.ratings.tsv ($(wc -l < data/title.ratings.tsv) lines)"
          echo "üìä All data files downloaded successfully!"
          ls -la data/

      - name: Verify data files before starting container
        run: |
          echo "üîç Verifying downloaded data files..."
          ls -la data/
          echo "üìä Data file sizes:"
          for file in data/*.tsv; do
            if [ -f "$file" ]; then
              echo "$(basename "$file"): $(wc -l < "$file") lines, $(du -h "$file" | cut -f1)"
            fi
          done

      - name: Clean up any existing containers
        run: |
          docker compose -f docker-compose.yml -p imdb down -v || true
          docker system prune -f || true

      - name: Start Postgres with fresh container
        run: docker compose -f docker-compose.yml -p imdb up -d

      - name: Wait for Postgres
        run: |
          until docker exec imdb_postgres pg_isready -U imdb; do
            echo "Waiting for postgres..."
            sleep 5
          done

      - name: Debug directories
        run: |
          echo "üîç Checking init scripts directory:"
          docker exec imdb_postgres ls -R /docker-entrypoint-initdb.d
          echo "üîç Checking data directory:"
          docker exec imdb_postgres ls -la /imdb_data/ || echo "‚ùå /imdb_data directory not found"
          echo "üîç Checking data file sizes:"
          docker exec imdb_postgres sh -c 'for file in /imdb_data/*.tsv; do [ -f "$file" ] && echo "$(basename "$file"): $(wc -l < "$file") lines" || echo "$(basename "$file"): not found"; done' || echo "‚ùå No data files found"

      - name: Show Postgres logs
        run: docker logs imdb_postgres

      - name: Load data manually (post-init) with robust error handling
        run: |
          echo "üìä Loading all IMDb data with robust error handling..."
          
          # Copy the robust loading script to container
          docker cp load_data_manual.sql imdb_postgres:/tmp/load_data_manual.sql
          
          # Execute the robust loading script
          docker exec -i imdb_postgres psql -U imdb -d imdb -f /tmp/load_data_manual.sql
          
          # Load remaining tables not covered in load_data_manual.sql
          echo "Loading title.akas.tsv..."
          docker exec -i imdb_postgres psql -U imdb -d imdb -c "
            DO \$\$
            BEGIN
              TRUNCATE TABLE title_akas;
              BEGIN
                -- Manual parsing to handle header row and type conversions
                CREATE TEMP TABLE temp_title_akas (raw_line TEXT);
                COPY temp_title_akas FROM '/imdb_data/title.akas.tsv' WITH (FORMAT text);
                
                INSERT INTO title_akas (titleId, ordering, title, region, language, types, attributes, isOriginalTitle)
                SELECT 
                  parts[1],
                  CASE WHEN parts[2] != '\N' AND parts[2] ~ '^[0-9]+$' THEN parts[2]::INTEGER ELSE NULL END,
                  parts[3],
                  parts[4],
                  parts[5],
                  parts[6],
                  parts[7],
                  CASE WHEN array_length(parts, 1) >= 8 THEN parts[8] ELSE NULL END
                FROM (
                  SELECT string_to_array(raw_line, E'\t') as parts 
                  FROM temp_title_akas 
                  WHERE raw_line NOT LIKE 'titleId%'
                ) t
                WHERE array_length(parts, 1) >= 8;
                
                DROP TABLE temp_title_akas;
                RAISE NOTICE 'Successfully loaded title_akas with manual parsing';
              EXCEPTION WHEN OTHERS THEN
                RAISE NOTICE 'Failed to load title_akas: %', SQLERRM;
              END;
            END
            \$\$;
            SELECT 'Loaded ' || COUNT(*) || ' rows into title_akas' FROM title_akas;
          "
          
          echo "Loading title.crew.tsv..."
          docker exec -i imdb_postgres psql -U imdb -d imdb -c "
            DO \$\$
            BEGIN
              TRUNCATE TABLE title_crew;
              BEGIN
                COPY title_crew FROM '/imdb_data/title.crew.tsv' 
                WITH (FORMAT text, DELIMITER E'\t', NULL '\N', ENCODING 'UTF8');
                RAISE NOTICE 'Successfully loaded title_crew with text format';
              EXCEPTION WHEN OTHERS THEN
                RAISE NOTICE 'Failed to load title_crew: %', SQLERRM;
              END;
            END
            \$\$;
            SELECT 'Loaded ' || COUNT(*) || ' rows into title_crew' FROM title_crew;
          "
          
          echo "Loading title.episode.tsv..."
          docker exec -i imdb_postgres psql -U imdb -d imdb -c "
            DO \$\$
            BEGIN
              TRUNCATE TABLE title_episode;
              BEGIN
                COPY title_episode FROM '/imdb_data/title.episode.tsv' 
                WITH (FORMAT text, DELIMITER E'\t', NULL '\N', ENCODING 'UTF8');
                RAISE NOTICE 'Successfully loaded title_episode with text format';
              EXCEPTION WHEN OTHERS THEN
                RAISE NOTICE 'Failed to load title_episode: %', SQLERRM;
              END;
            END
            \$\$;
            SELECT 'Loaded ' || COUNT(*) || ' rows into title_episode' FROM title_episode;
          "
          
          echo "Loading title.principals.tsv..."
          docker exec -i imdb_postgres psql -U imdb -d imdb -c "
            DO \$\$
            BEGIN
              TRUNCATE TABLE title_principals;
              BEGIN
                -- Manual parsing to handle header row and type conversions
                CREATE TEMP TABLE temp_title_principals (raw_line TEXT);
                COPY temp_title_principals FROM '/imdb_data/title.principals.tsv' WITH (FORMAT text);
                
                INSERT INTO title_principals (tconst, ordering, nconst, category, job, characters)
                SELECT 
                  parts[1],
                  CASE WHEN parts[2] != '\N' AND parts[2] ~ '^[0-9]+$' THEN parts[2]::INTEGER ELSE NULL END,
                  parts[3],
                  parts[4],
                  parts[5],
                  parts[6]
                FROM (
                  SELECT string_to_array(raw_line, E'\t') as parts 
                  FROM temp_title_principals 
                  WHERE raw_line NOT LIKE 'tconst%'
                ) t
                WHERE array_length(parts, 1) >= 6;
                
                DROP TABLE temp_title_principals;
                RAISE NOTICE 'Successfully loaded title_principals with manual parsing';
              EXCEPTION WHEN OTHERS THEN
                RAISE NOTICE 'Failed to load title_principals: %', SQLERRM;
              END;
            END
            \$\$;
            SELECT 'Loaded ' || COUNT(*) || ' rows into title_principals' FROM title_principals;
          "

      - name: Verify all tables created and loaded
        run: |
          echo "üîç Checking all tables..."
          docker exec -i imdb_postgres psql -U imdb -d imdb -c "\dt"
          
          echo "üìä Comprehensive data verification for all 7 IMDb tables..."
          docker exec -i imdb_postgres psql -U imdb -d imdb -c "
            SELECT 
              'name_basics' as table_name, COUNT(*) as row_count FROM name_basics
            UNION ALL
            SELECT 
              'title_basics' as table_name, COUNT(*) as row_count FROM title_basics  
            UNION ALL
            SELECT 
              'title_ratings' as table_name, COUNT(*) as row_count FROM title_ratings
            UNION ALL
            SELECT 
              'title_akas' as table_name, COUNT(*) as row_count FROM title_akas
            UNION ALL
            SELECT 
              'title_crew' as table_name, COUNT(*) as row_count FROM title_crew
            UNION ALL
            SELECT 
              'title_episode' as table_name, COUNT(*) as row_count FROM title_episode
            UNION ALL
            SELECT 
              'title_principals' as table_name, COUNT(*) as row_count FROM title_principals
            ORDER BY table_name;
          "
          
          echo "‚úÖ Verifying minimum expected row counts..."
          docker exec -i imdb_postgres psql -U imdb -d imdb -c "
            DO \$\$
            DECLARE
              name_count INTEGER;
              title_count INTEGER;
              ratings_count INTEGER;
            BEGIN
              SELECT COUNT(*) INTO name_count FROM name_basics;
              SELECT COUNT(*) INTO title_count FROM title_basics;
              SELECT COUNT(*) INTO ratings_count FROM title_ratings;
              
              IF name_count < 1000000 THEN
                RAISE EXCEPTION 'name_basics has insufficient data: % rows', name_count;
              END IF;
              
              IF title_count < 1000000 THEN
                RAISE EXCEPTION 'title_basics has insufficient data: % rows', title_count;
              END IF;
              
              IF ratings_count < 100000 THEN
                RAISE EXCEPTION 'title_ratings has insufficient data: % rows', ratings_count;
              END IF;
              
              RAISE NOTICE 'All core tables have sufficient data loaded successfully!';
            END
            \$\$;
          "

      - name: Show Postgres logs
        run: docker logs imdb_postgres

      - name: Run Chris Hemsworth query
        run: docker exec -i imdb_postgres psql -U imdb -d imdb -f /queries/chris_hemsworth_movies.sql