name: IMDb Pipeline

on:
  workflow_dispatch:

jobs:
  imdb:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: imdb
          POSTGRES_PASSWORD: imdb
          POSTGRES_DB: imdb
        options: >-
          --health-cmd="pg_isready -U imdb -d imdb"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends wget curl postgresql-client gzip
          sudo rm -rf /var/lib/apt/lists/*

      - name: Download IMDb data
        run: |
          mkdir -p data
          for file in name.basics title.akas title.basics title.crew title.episode title.principals title.ratings; do
            wget -q "https://datasets.imdbws.com/$file.tsv.gz" -O - | gunzip > "data/$file.tsv"
          done
          ls -lh data/

      - name: Initialize Schema
        run: psql -h localhost -U imdb -d imdb -f ./sql/00_schema.sql
        env:
          PGPASSWORD: imdb

      - name: Load tables
        run: |
          for file in data/*.tsv; do
            tbl=$(basename "$file" .tsv | tr '.' '_')
            echo "ðŸ“Š Loading $tbl..."
            psql -h localhost -U imdb -d imdb -c "\COPY $tbl FROM '$file' WITH (FORMAT text, DELIMITER E'\t', NULL '\N', HEADER true)"
          done
        env:
          PGPASSWORD: imdb

      - name: Verify tables
        run: |
          psql -h localhost -U imdb -d imdb -c "\dt"
          psql -h localhost -U imdb -d imdb -c "
            SELECT table_name, row_estimate
            FROM (
              SELECT relname as table_name, reltuples::bigint as row_estimate
              FROM pg_class WHERE relkind='r'
            ) est
            WHERE table_name IN ('name_basics','title_basics','title_ratings','title_akas','title_crew','title_episode','title_principals')
            ORDER BY table_name;
          "
        env:
          PGPASSWORD: imdb

      - name: Run Chris Hemsworth query
        run: psql -h localhost -U imdb -d imdb -f queries/chris_hemsworth_movies.sql
        env:
          PGPASSWORD: imdb
